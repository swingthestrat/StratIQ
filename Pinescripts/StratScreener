//@version=6
indicator("NJ - theSTRAT Screener V4 + Ranking", overlay=true, max_labels_count=500) 

// === Original Screener Code (unchanged) ===

lookback = input.int(0, minval=0, title="Lookback (bars ago for metrics)")

// === Constants ===
//ONE          = '1'
//TWOU         = 'u'
//TWOD         = 'd'
//THREE        = '3'
//STRAT_COMBO_OFFSET = 3
//ACTIONABLE_OFFSET  = 2
FIRST   = 0
SECOND  = 1
THIRD   = 2
FOURTH  = 3
BAR_OFFSET = 1
ACTION_WICK_PCT = 0.75

//TF_QTR  = "3M"
//TF_MON  = "M"
//TF_WEEK = "W"
//TF_DAY  = "D"
//TF_30M  = "30"

// 1. Bundle data: 5 request.security calls ONLY
dOpen = request.security(syminfo.tickerid, "D", open, barmerge.gaps_off, barmerge.lookahead_on)
dHigh = request.security(syminfo.tickerid, "D", high, barmerge.gaps_off, barmerge.lookahead_on)
dLow  = request.security(syminfo.tickerid, "D", low,  barmerge.gaps_off, barmerge.lookahead_on)
pdHigh = request.security(syminfo.tickerid, "D", high[1], barmerge.gaps_off, barmerge.lookahead_on)
pdLow  = request.security(syminfo.tickerid, "D", low[1], barmerge.gaps_off, barmerge.lookahead_on)
pdClose= request.security(syminfo.tickerid, "D", close[1], barmerge.gaps_off, barmerge.lookahead_on)

[o60, c60, h60, l60, o60_1, c60_1, h60_1, l60_1] = request.security(syminfo.tickerid, "60",  [open, close, high, low, open[1], close[1], high[1], low[1]],lookahead=barmerge.lookahead_on)
[oD, cD, hD, lD, vD, oD1, cD1, hD1, lD1] = request.security(syminfo.tickerid, "D", [open, close, high, low, volume, open[1], close[1], high[1], low[1]], lookahead=barmerge.lookahead_on)
[oW, cW, hW, lW, vW, oW1, cW1, hW1, lW1] = request.security( syminfo.tickerid, "W",[open, close, high, low, volume, open[1], close[1], high[1], low[1]], lookahead=barmerge.lookahead_on)
[oM, cM, hM, lM, vM, oM1, cM1, hM1, lM1] = request.security( syminfo.tickerid, "M", [open, close, high, low, volume, open[1], close[1], high[1], low[1]], lookahead=barmerge.lookahead_on)

//[oQ, cQ, hQ, lQ, vQ, oQ1, cQ1, hQ1, lQ1] = request.security( syminfo.tickerid, "3M", [open, close, high, low, volume, open[1], close[1], high[1], low[1]], lookahead=barmerge.lookahead_on)
//[oY, cY, hY, lY, vY, oY1, cY1, hY1, lY1] = request.security( syminfo.tickerid, "12M", [open, close, high, low, volume, open[1], close[1], high[1], low[1]], lookahead=barmerge.lookahead_on)


[spyC, spyL] = request.security("SPY", timeframe.period, [close, low])


// ADR ATR

//atr14 = ta.atr(14)

// 2. ADR, Change% Calculations
adr_rank = ta.sma(hD - lD, 14)
//adr_percent_rank = 100 * (ta.sma(hD / lD, 14) - 1)
//adr_amount_rank = close * (adr_percent_rank / 100)

atr = ta.atr(14)
adr = ta.sma(high - low, 14) 
arp = 100 * (ta.sma(high / low, 14) - 1)
adr_percent = request.security(syminfo.tickerid, 'D', arp)




// --- 5DMA LOGIC (adaptive)
calc_dynamic_period() =>
    if timeframe.isdaily
        5
    else if timeframe.isweekly
        1
    else
        minutes_in_5_days = 5 * 390
        timeframe_in_minutes = timeframe.multiplier
        timeframe_in_minutes != 0 ? math.round(minutes_in_5_days / timeframe_in_minutes) : 1

dynamic_period = calc_dynamic_period()
ma5 = ta.sma(close, dynamic_period)

// === STRAT Bar Type Detectors ===
f_oneBar(r, l)   => high[r] <= high[l] and low[r] >= low[l]
f_twoUpBar(r, l) => high[r] > high[l] and not (low[r] <= low[l])
f_twoDnBar(r, l) => low[r] < low[l] and not (high[r] >= high[l])
f_threeBar(r, l) => high[r] > high[l] and low[r] < low[l]

f_idxOneBar(idx)   => f_oneBar(idx, idx+BAR_OFFSET)
f_idxTwoUpBar(idx) => f_twoUpBar(idx, idx+BAR_OFFSET)
f_idxTwoDnBar(idx) => f_twoDnBar(idx, idx+BAR_OFFSET)
f_idxThreeBar(idx) => f_threeBar(idx, idx+BAR_OFFSET)

isOne      = f_idxOneBar(0)
isTwoUp    = f_idxTwoUpBar(0)
isTwoDn    = f_idxTwoDnBar(0)
isThree    = f_idxThreeBar(0)
isBullish  = close[0] > open[0]
isBearish  = open[0] > close[0]

isOneBar   = f_idxOneBar(0)
isTwoUpBar = f_idxTwoUpBar(0)
isTwoDnBar = f_idxTwoDnBar(0)
isThreeBar = f_idxThreeBar(0)

// === STRAT Combo Patterns (full list) ===
is222Bear = f_idxTwoDnBar(THIRD) and f_idxTwoDnBar(SECOND) and f_idxTwoDnBar(FIRST)
is222Bull = f_idxTwoUpBar(THIRD) and f_idxTwoUpBar(SECOND) and f_idxTwoUpBar(FIRST)
is212BearCont = f_idxTwoDnBar(THIRD) and f_idxOneBar(SECOND) and f_idxTwoDnBar(FIRST)
is212BullCont = f_idxTwoUpBar(THIRD) and f_idxOneBar(SECOND) and f_idxTwoUpBar(FIRST)

is22BearRev   = f_idxTwoUpBar(SECOND) and f_idxTwoDnBar(FIRST) and not f_idxOneBar(THIRD) and not f_idxTwoDnBar(THIRD) and not f_idxTwoDnBar(3) and not f_idxThreeBar(THIRD)
is22BullRev   = f_idxTwoDnBar(SECOND) and f_idxTwoUpBar(FIRST) and not f_idxOneBar(THIRD) and not f_idxTwoUpBar(THIRD) and not f_idxTwoUpBar(3) and not f_idxThreeBar(THIRD)
is212BearRev  = f_idxTwoUpBar(THIRD) and f_idxOneBar(SECOND) and f_idxTwoDnBar(FIRST)
is212BullRev  = f_idxTwoDnBar(THIRD) and f_idxOneBar(SECOND) and f_idxTwoUpBar(FIRST)
is322BearRev  = f_idxThreeBar(THIRD) and f_idxTwoUpBar(SECOND) and f_idxTwoDnBar(FIRST)
is322BullRev  = f_idxThreeBar(THIRD) and f_idxTwoDnBar(SECOND) and f_idxTwoUpBar(FIRST)
is32BearRev   = f_idxThreeBar(SECOND) and f_idxTwoDnBar(FIRST)
is32BullRev   = f_idxThreeBar(SECOND) and f_idxTwoUpBar(FIRST)
is312BearRev  = f_idxThreeBar(THIRD) and f_idxOneBar(SECOND) and f_idxTwoDnBar(FIRST)
is312BullRev  = f_idxThreeBar(THIRD) and f_idxOneBar(SECOND) and f_idxTwoUpBar(FIRST)
is122BearRsRv = f_idxOneBar(THIRD) and f_idxTwoUpBar(SECOND) and f_idxTwoDnBar(FIRST)
is122BullRsRv = f_idxOneBar(THIRD) and f_idxTwoDnBar(SECOND) and f_idxTwoUpBar(FIRST)
is2222BearRJ  = f_idxTwoDnBar(FOURTH) and f_idxTwoDnBar(THIRD) and f_idxTwoUpBar(SECOND) and f_idxTwoDnBar(FIRST)
is2222BullRJ  = f_idxTwoUpBar(FOURTH) and f_idxTwoUpBar(THIRD) and f_idxTwoDnBar(SECOND) and f_idxTwoUpBar(FIRST)
is3BearRsRv   = f_idxThreeBar(FIRST) and close[0] < low[1]
is3BullRsRv   = f_idxThreeBar(FIRST) and close[0] > low[1]
is13      = f_idxOneBar(SECOND) and f_idxThreeBar(FIRST)
is31      = f_idxThreeBar(SECOND) and f_idxOneBar(FIRST)
is11      = f_idxOneBar(SECOND) and f_idxOneBar(FIRST)


// Common Pivot Combo
is2d_2d_2u = f_idxTwoDnBar(THIRD) and f_idxTwoDnBar(SECOND) and f_idxTwoUpBar(FIRST)
is2d_2d_1 = f_idxTwoDnBar(THIRD) and f_idxTwoDnBar(SECOND) and f_idxOneBar(FIRST)
is2d_3u_2u = f_idxTwoDnBar(THIRD) and (f_idxThreeBar(SECOND) and isBullish[SECOND]) and f_idxTwoUpBar(FIRST)

is2u_2u_2d = f_idxTwoUpBar(THIRD) and f_idxTwoUpBar(SECOND) and f_idxTwoDnBar(FIRST)
is2u_2u_1 = f_idxTwoUpBar(THIRD) and f_idxTwoUpBar(SECOND) and f_idxOneBar(FIRST)
is2u_3d_2d = f_idxTwoUpBar(THIRD) and (f_idxThreeBar(SECOND) and isBearish[SECOND]) and f_idxTwoDnBar(FIRST)



// Actionable Signal Logic 
getActionableWickHeight(wickPct) => (high[0] - low[0]) * wickPct
getShooterTop = high[0] - getActionableWickHeight(ACTION_WICK_PCT)
getHammerBt   = low[0]  + getActionableWickHeight(ACTION_WICK_PCT)
isInsideBar   = f_idxOneBar(FIRST)
isShooter     = open[0] < getShooterTop and close[0] < getShooterTop 
isHammer      = open[0] > getHammerBt   and close[0] > getHammerBt   

getPrevWickHeight(wickPct) => (high[1] - low[1]) * wickPct
getShooterTopPrev = high[1] - getPrevWickHeight(ACTION_WICK_PCT)
getHammerBtPrev   = low[1]  + getPrevWickHeight(ACTION_WICK_PCT)
isInsideBarPrev = f_idxOneBar(SECOND)
isPrevDayShooter = open[1] < getShooterTopPrev and close[1] < getShooterTopPrev
isPrevDayHammer  = open[1] > getHammerBtPrev   and close[1] > getHammerBtPrev   

// === Grouped Patterns for Alerts/Filters ===
isContinuation = is222Bear or is222Bull or is212BearCont or is212BullCont
isReversal = is22BearRev or is22BullRev or is212BearRev or is212BullRev or is322BearRev or is322BullRev or is32BearRev or is32BullRev or is312BearRev or is312BullRev or is122BearRsRv or is122BullRsRv or is3BearRsRv or is3BullRsRv
bullishPivot = (is2d_2d_2u or is2d_2d_1 or is2d_3u_2u  or is2222BullRJ) and isBullish
bearishPivot = (is2u_2u_2d or is2u_2u_1 or is2u_3d_2d  or is2222BearRJ) and isBearish

// actionableSignal = 2d-2u, Hammer, 2dG, 3u

actionableSignal = ((isTwoDnBar[1] and isTwoUpBar and isBullish) or isHammer or (isTwoDnBar and isBullish)) or (isThreeBar[1] and isBullish[1] and isBullish)
//kicking = oD1 > cD1 and (dOpen > (dLow[1]  + (atr * 0.6))) and dOpen > cD1


// === Strat Bar Values ===
stratBar = float(na)
stratBar := isOne and isBullish      ? 1     : isOne and isBearish      ? -1    : isTwoUp and isBullish    ? 2     : isTwoUp and isBearish    ? 1.5   :  isTwoDn and isBullish    ? -1.5  :  isTwoDn and isBearish    ? -2    : isThree and isBullish    ? 3     : isThree and isBearish    ? -3    : -1.5


// === LOD/DCR Calculation ====

ATR_LEN = 20
atrVal   = ta.atr(ATR_LEN)
lodDist  = 100 * ((close - low) / atrVal)
dcr      = ((close - low) / (high - low)) * 100



// === GAP Calculation ===

gapDownOpen = dOpen < pdLow
gapUpOpen   = dOpen > pdHigh
PDLtaken    = dLow  < pdLow
PDHtaken    = dHigh > pdHigh

gapPct  = (dOpen - pdClose) / pdClose * 100
chgFromOpen = (close - dOpen)/ dOpen * 100



kicking = (gapDownOpen and gapPct > (adr_percent * - 0.5)) or (gapUpOpen and gapPct > (adr_percent * 0.5)) 


// === RVOL TOD




lookback_days   = 50 // input.int(50, "Lookback Days", minval=1)
session_minutes = 390 // input.int(390, "Session Length (minutes)", minval=1)

//[vD] = request.security(syminfo.tickerid, "D", [volume], lookahead=barmerge.lookahead_on)

// Bars per day (guard against 0) 
bar_length_min = timeframe.in_seconds() / 60
bars_per_day_f = session_minutes / bar_length_min
bars_per_day   = math.max(1, int(math.round(bars_per_day_f)))  // ensure at least 1

// New day detection
is_new_day = ta.change(time("D")) != 0

// Running cumulative volume & bar index (for current day)
var float cum_vol_today = 0.0
var int   bar_in_day    = 0

// Arrays: historical sums, day counts, and today's per-bar storage 
var array<float> cum_hist_sum   = array.new_float() // sum of cumulative volumes for each intraday bar index
var array<int>   day_count      = array.new_int()
var array<float> today_cum_store = array.new_float()

// Ensure arrays are the correct size (reinitialize if timeframe / chart changed)
if array.size(cum_hist_sum) != bars_per_day
    array.clear(cum_hist_sum)
    array.clear(day_count)
    array.clear(today_cum_store)
    for i = 0 to bars_per_day - 1
        array.push(cum_hist_sum, 0.0)
        array.push(day_count, 0)
        array.push(today_cum_store, na)

// If new day: push yesterday's stored cumulative values into historical sums ===
if is_new_day
    // previous day's number of intraday bars (from last bar)
    prev_bars = bar_in_day[1]
    if prev_bars > 0
        // add each stored cumulative value from yesterday into hist arrays
        for i = 0 to math.min(prev_bars - 1, bars_per_day - 1)
            yval = array.get(today_cum_store, i)
            if not na(yval)
                array.set(cum_hist_sum, i, array.get(cum_hist_sum, i) + yval)
                array.set(day_count, i, array.get(day_count, i) + 1)
                array.set(today_cum_store, i, na) // clear slot for new day
    // start new day
    cum_vol_today := volume
    bar_in_day    := 1
    // store first bar cumulative for today
    if bars_per_day >= 1
        array.set(today_cum_store, 0, cum_vol_today)
else
    // continuing the same day
    cum_vol_today += volume
    bar_in_day    += 1
    // record cumulative value if within expected intraday range
    if bar_in_day <= bars_per_day
        array.set(today_cum_store, bar_in_day - 1, cum_vol_today)

// Compute average cumulative for this intraday position and Relative Volume ===
float avg_cum_vol = na
if bar_in_day <= bars_per_day
    hist_sum   = array.get(cum_hist_sum, bar_in_day - 1)
    hist_cnt   = array.get(day_count,    bar_in_day - 1)
    avg_cum_vol := (hist_cnt > 0) ? hist_sum / hist_cnt : na

float rel_vol = na
if not na(avg_cum_vol) and avg_cum_vol > 0
    rel_vol := cum_vol_today / avg_cum_vol


//=== Begin Ranking Logic Integration ===




// === Change Percentages & Color === 
calc_change_percentage(tf) =>
    tf_close = request.security(syminfo.tickerid, tf, close, barmerge.gaps_off, barmerge.lookahead_on)
    tf_open  = request.security(syminfo.tickerid, tf, open,  barmerge.gaps_off, barmerge.lookahead_on)
    (tf_close - tf_open) / tf_open * 100

change30   = calc_change_percentage("30")
changeD    = calc_change_percentage("D")
changeW    = calc_change_percentage("W")
changeM    = calc_change_percentage("M")

ftfc    = changeD  > adr_percent * -1 and 
          changeW  > adr_percent * -1 and 
          changeM  > adr_percent * -1  

//actionableSignal = ((isTwoDnBar[1] and isTwoUpBar)or isHammer ) and close >= ma5- 0.6 * atr and ftfc and(close - low < 1 * atr) and close > open



is_mon_green  = changeM > 0
is_wk_green   = changeW > 0
is_d_green    = changeD > 0
is_30m_green  = change30 > 0


// percentage change vs. open per timeframe
changePct(open_, close_) =>
    (close_ - open_) / open_ * 100

change60 = changePct(o60, c60)
changeD_rank  = changePct(oD, cD)
changeW_rank  = changePct(oW, cW)
changeM_rank  = changePct(oM, cM)


// Quarterly & Yearly change workaround
varip float quarterOpen = na
varip float yearOpen = na

varip int lastQuarter = na
varip int lastYear = na


curQuarter = math.floor((month-1) / 3)

if na(lastQuarter) or curQuarter != lastQuarter
    quarterOpen := open
    lastQuarter := curQuarter


if na(lastYear) or year != lastYear
    yearOpen := open
    lastYear := year

change3M = (close - quarterOpen) / quarterOpen * 100
change12M = (close - yearOpen) / yearOpen * 100




n_changeD = changeD_rank / adr_percent
n_changeW = changeW_rank / adr_percent
n_changeM = changeM_rank / adr_percent
n_change3M = change3M / adr_percent

// 3. Actionable Strat Signals â€” for D/W/M only
ACTION_WICK = 0.75

getSignals(h, l, o, c, h1, l1, o1, c1) =>
    wickH = (h - l) * ACTION_WICK
    shooterT = h - wickH
    hammerB = l + wickH
    isInside = h < h1 and l > l1
    isShooter = o < shooterT and c < shooterT and not isInside
    isHammer  = o > hammerB and c > hammerB and not isInside
    is2Up = h > h1 and l > l1
    is2Dn = l < l1 and h < h1
    isBull = c > o
    isBear = c < o
    is2UpRed = is2Up and isBear
    is2DnGreen = is2Dn and isBull
    is3Bar = h > h1 and l < l1
    is3u = is3Bar and isBull
    is3d = is3Bar and isBear
    is1u = isInside and isBull
    is1d = isInside and isBear
    signals = ''
    float bullish = 0.0, bearish = 0.0

    if is1u
        signals += "1u"
        bullish += 0.5
    if is2DnGreen
        signals += " 2d-G"
        bullish += 1.5
    if is3u
        signals += " 3u"
        bullish += 1
    if isHammer
        signals += " 3u"
        bullish += 1.5
    if is1d
        signals += "1d"
        bearish += 0.5
    if is2UpRed
        signals += " 2u-R"
        bearish += 1.5
    if is3d
        signals += " 3d"
        bearish += 1
    if isShooter
        signals += " 3d"
        bearish += 1.5
    if isInside
        signals += " I"
    [signals, isInside, bullish, bearish]

[signalsD, insideD, bullishD, bearishD] = getSignals(hD, lD, oD, cD, hD1, lD1, oD1, cD1)
[signalsW, insideW, bullishW, bearishW] = getSignals(hW, lW, oW, cW, hW1, lW1, oW1, cW1)
[signalsM, insideM, bullishM, bearishM] = getSignals(hM, lM, oM, cM, hM1, lM1, oM1, cM1)

// 4. High Volume Edge
volMA = ta.sma(vD, 20)
volThresh = volMA * 1.7
isHighVol = vD > volThresh
consecHighVol = isHighVol and isHighVol[1]
highVolCount = 0
for i = 0 to 4
    highVolCount += isHighVol[i] ? 1 : 0
highVol5 = highVolCount >= 2

yearBars = 252
quarterBars = 63
ipoBars = 365
highestEver = ta.highest(vD, ipoBars)
highestYear = ta.highest(vD, yearBars)
highestQuarter = ta.highest(vD, quarterBars)
isHighestEver = vD == highestEver
isHighestYear = vD == highestYear
isHighestQuarter = vD == highestQuarter

unusualVolume = consecHighVol or highVol5 or isHighestEver or isHighestQuarter or isHighestYear or isHighVol

vWeek = ta.sma(vD, 5)
vMonth = ta.sma(vD, 21)
vQuarter = ta.sma(vD, 63)

rvW   = vD / vWeek
rvM   = vWeek / vMonth
rvQ   = vMonth / vQuarter
rvSum = rvW + rvM + rvQ

greenDot3 = rvSum == ta.highest(rvSum, 250)
greenDot2 = rvSum == ta.highest(rvSum, 63)
greenDot1 = rvSum == ta.highest(rvSum, 21)
pinkDot3 = rvSum == ta.lowest(rvSum, 250)
pinkDot2 = rvSum == ta.lowest(rvSum, 63)
pinkDot1 = rvSum == ta.lowest(rvSum, 21)

volumeDots = greenDot1 or greenDot2 or greenDot3 or pinkDot1 or pinkDot2 or pinkDot3

// 5. Relative Strength (vs. SPY)
baseClose = close
spyClose = spyC

rs63 = baseClose / baseClose[21] / (spyClose / spyClose[21]) - 1

y0 = rs63 - rs63[15]
angle0 = math.atan(y0 / 15)

ema21_rs = ta.ema(rs63, 21)
rsema21_rise = ta.rising(ema21_rs, 3)
rsema21_fall = ta.falling(ema21_rs, 3)

spx = spyL
rs = (low / spx) * 100
ema = ta.ema(rs,21)
dist = ((rs - ema) / rs) * 100
ema1 = ta.ema(dist, 3)
ema2 = ta.ema(dist, 13)

rsAboveEMA = dist > 0 ? 1 : -1
shortEMAMom = ema1 > ema1[1] ? 1 : -1
longEMAMom = ema2 > ema2[1] ? 1 : -1
rsEMACross = ema1 > ema2 ? 1 : -1

RS = rsAboveEMA + shortEMAMom + longEMAMom + rsEMACross

RS63 = (rs63 > 0           ? 1 : -1) +
       (rs63 > ema21_rs    ? 1 : -1) +
       (rsema21_rise       ? 1 : 0) +
       (rsema21_fall       ? -1 : 0) +
       (angle0 > 0         ? 1 : -1)

// 6. Rolling 5-day DMA (using close)
trendBars = 2 //input.int(2, "Rising/Falling Lookback", minval=1)
dynamic_period_rank = 5

dma5 = ta.sma(close, dynamic_period_rank)
dma5_rising = ta.rising(dma5, trendBars)
dma5_falling = ta.falling(dma5, trendBars)
y5 = dma5 - dma5[15]
angle5 = math.atan(y5 / 15)

score_priceAbove = close > dma5      ? 1 : -1
score_rising     = dma5_rising       ? 1 : 0
score_falling    = dma5_falling      ? -1 : 0
score_angle      = angle5 > 0        ? 1 : -1
DMA5 = score_priceAbove + score_rising + score_falling + score_angle

// 7. HVE score
HVE1 = (consecHighVol ? 2 : 0) + (highVol5 ? 2.5 : 0) + (isHighVol and close > open ? 1 : 0) + (isHighestEver and close > close[1] ? 1 : 0) + (isHighestQuarter and close > close[1] ? 1 : 0) + (isHighestYear and close > close[1] ? 1 : 0) - (isHighVol and close < open ? 1 : 0) - (isHighestEver and close < close[1] ? 1 : 0)

HVE2 = pinkDot3 ? 3 :
       pinkDot2 ? 2 :
       pinkDot1 ? 1 :
       greenDot3 ? -3 :
       greenDot2 ? -2 :
       greenDot1 ? -1 :
       0

                     
HVE = HVE1 + HVE2

// 8. Actionable signal score
bullishAS = bullishD * 0.75 + bullishW + bullishM * 1.25
bearishAS = bearishD * 0.75 + bearishW + bearishM * 1.25

// 9. All-in-one Rank
TFC = (n_changeD > 0 ? 0.5 : -0.5) +
      (n_changeW > 0 ? 1 : -1) +
      (n_changeM > 0 ? 2 : -2) +
      (n_change3M > 0 ? 2.5 : -2.5)

rank0 = RS + RS63 + TFC + DMA5 + HVE + bullishAS - bearishAS

// Volatility Calculation
atrPct = (atr / close) * 100

// Clamp ATR %
atrMin = 0.5
atrMax = 5.0
atrPctClamped = math.min(math.max(atrPct, atrMin), atrMax)

// Normalization function
normalize(x) => x / atrPctClamped

// Adjusted component scores
RS_adj         = normalize(RS)
RS63_adj       = normalize(RS63)
DMA5_adj       = normalize(DMA5)
TFC_adj        = normalize(TFC)
HVE_adj        = normalize(HVE)
bullishAS_adj  = normalize(bullishAS)
bearishAS_adj  = normalize(bearishAS)

// Rebuild rank with volatility-adjusted components
rank = RS_adj + RS63_adj + TFC_adj + DMA5_adj + HVE_adj + bullishAS_adj - bearishAS_adj


// ---- Labeling rank information ----
//var label rankingLabel = na
//if barstate.islast and not na(rank)
//    label.delete(rankingLabel)
//    rankingLabel := label.new(bar_index, rank, 'Rank ' + str.tostring(math.round(rank,2)), 
//                     xloc.bar_index, yloc.price, style=label.style_label_left, color=color.blue, textcolor=color.white )

//var label rankScoreLabel = na
//if barstate.islast and not na(rank_scaled_0_100)
//    label.delete(rankScoreLabel)
//    rankScoreLabel := label.new(bar_index, rank, 'Rank Score ' + str.tostring(math.round(rank_scaled_0_100,0)), 
//                     xloc.bar_index, yloc.price, style=label.style_label_lower_left, color=color.blue, textcolor=color.white )

//var label PercentileLabel = na
//if barstate.islast and not na(rank_final)
//    label.delete(PercentileLabel)
//    PercentileLabel := label.new(bar_index, rank, 'HVE ' + str.tostring(math.round(HVE2,1)), 
//                     xloc.bar_index, yloc.price, style=label.style_label_upper_left, color=color.blue, textcolor=color.white )

// EMA of rank for visualization
//rank_ema = ta.ema(rank, 21)
//rank_ema_color = rank > rank_ema ? color.new(color.green, 0) : color.new(color.red, 0)
//rank_fill_color = rank > rank_ema ? color.new(color.green, 70) : color.new(color.red, 70)

//rank_plot = plot(rank, color=color.new(color.black, 50), title="Rank", linewidth=2)
//rank_ema_plot = plot(rank_ema, color=rank_ema_color, title="Rank EMA", linewidth=3)

//fill(rank_plot, rank_ema_plot, color=rank_fill_color)

// Dot conditions on rank line
greenDot  = close == ta.highest(close, 250)
pinkDot   = rank  == ta.highest(rank, 63)
blueDot   = ta.crossover(rank, 0)

//plot(greenDot  ? rank : na, title="New Price High (Green Dot)",  color=color.new(color.green, 50),  linewidth=10, style=plot.style_circles)
//plot(pinkDot   ? rank : na, title="New Rank High (Blue Dot)",   color=color.new(color.fuchsia,  50), linewidth=10, style=plot.style_circles)
//plot(blueDot  ? rank : na, title="Rank Crosses Zero (Yellow Dot)", color=color.new(color.blue, 50), linewidth=10, style=plot.style_circles)

//// Kicking




// === Alerts ===
alertcondition(volumeDots[lookback],           title="Volume Dots",             message="volume Dots")
alertcondition(kicking[lookback],           title="Kicking",             message="Kicking")
alertcondition(isOneBar[lookback],         title="1",             message="Scenario 1 Bar")
alertcondition(isTwoUpBar[lookback],       title="2u",          message="Scenario 2 Up Bar")
alertcondition(isTwoDnBar[lookback],       title="2d",        message="Scenario 2 Down Bar")
alertcondition(isThreeBar[lookback],       title="3",             message="Scenario 3 Bar")
alertcondition(isBullish[lookback],        title="Green",       message="Bullish Bar")
alertcondition(isBearish[lookback],        title="Red",       message="Bearish Bar")
alertcondition(isBullish[lookback + 1],     title="Green[1]",       message="Bullish Bar")
alertcondition(isBearish[lookback + 1],     title="Red[1]",       message="Bearish Bar")
alertcondition(isTwoUpBar[lookback] and isBearish[lookback],  title="2u & R",   message="2 Up & Red")
alertcondition(isTwoDnBar[lookback] and isBullish[lookback],  title="2d & G",message="2 Down & Green")
alertcondition(actionableSignal[lookback],         title="Actionable", message="Actionable Signal Detected")
alertcondition(isHammer[lookback],         title="Hammer", message="Hammer Actionable Signal Detected")
alertcondition(isShooter[lookback],        title="Shooter",message="Shooter Actionable Signal Detected")
alertcondition(bullishPivot[lookback],         title="Bullish Pivot", message="Bullish Pivot")
alertcondition(bearishPivot[lookback],         title="Bearish Pivot", message="Bearish Pivot")
alertcondition(isPrevDayShooter[lookback], title="Shooter[1]", message="Shooter Actionable Signal Detected - Previous Bar")
alertcondition(isPrevDayHammer[lookback],  title="Hammer[1]", message="Hammer Actionable Signal Detected - Previous Bar")
alertcondition(gapDownOpen[lookback],      title="Gap Down",        message="Gap Down")
alertcondition(gapUpOpen[lookback],        title="Gap Up",          message="Gap up")
alertcondition(PDHtaken[lookback],         title="PDH Taken",       message="PDH taken")
alertcondition(PDLtaken[lookback],         title="PDL Taken",       message="PDL taken")
alertcondition(isContinuation[lookback],   title="Continuation",    message="Continuation Pattern Detected")
alertcondition(isReversal[lookback],       title="Reversals",       message="Reversals Pattern Detected")
alertcondition(is222Bear[lookback],        title="2d-2d-2d", message="222 Bearish Continuation Pattern Detected")
alertcondition(is222Bull[lookback],        title="2u-2u-2u", message="222 Bullish Continuation Pattern Detected")
alertcondition(is212BearCont[lookback],    title="2d-1-2d", message="212 Bearish Continuation Measured Move Pattern Detected")
alertcondition(is212BullCont[lookback],    title="2u-1-2u",  message="212 Bullish Continuation Measured Move Pattern Detected")
alertcondition(is22BearRev[lookback],      title="2u-2d",    message="22 Bearish Reversal Pattern Detected")
alertcondition(is22BullRev[lookback],      title="2u-2d",    message="22 Bullish Reversal Pattern Detected")
alertcondition(is212BearRev[lookback],     title="2u-1-2d",   message="212 Bearish Reversal Pattern Detected")
alertcondition(is212BullRev[lookback],     title="2d-1-2u",   message="212 Bullish Reversal Pattern Detected")
alertcondition(is322BearRev[lookback],     title="3-2u-2d",   message="322 Bearish Reversal Pattern Detected")
alertcondition(is322BullRev[lookback],     title="3-2d-2u",   message="322 Bullish Reversal Pattern Detected")
alertcondition(is32BearRev[lookback],      title="3-2d",    message="32 Bearish Reversal Pattern Detected")
alertcondition(is32BullRev[lookback],      title="3-2u",    message="32 Bullish Reversal Pattern Detected")
alertcondition(is312BearRev[lookback],     title="3-1-2d",   message="312 Bearish Reversal Pattern Detected")
alertcondition(is312BullRev[lookback],     title="3-1-2u",   message="312 Bullish Reversal Detected")
alertcondition(is122BearRsRv[lookback],    title="1-2u-2d", message="122 Bearish RevStrat Reversal Pattern Detected")
alertcondition(is122BullRsRv[lookback],    title="1-2d-2u", message="122 Bullish RevStrat Reversal Pattern Detected")
alertcondition(is3BearRsRv[lookback],      title="3d", message="3 Bearish RevStrat Reversal Pattern Detected")
alertcondition(is3BullRsRv[lookback],      title="3u", message="3 Bullish RevStrat Reversal Pattern Detected")
alertcondition(is2222BearRJ[lookback],     title="2d-2d-2u-2d RJ", message="2222 Bearish Randy Jackson Pattern Detected")
alertcondition(is2222BullRJ[lookback],     title="2u-2u-2d-2u Bullish RJ", message="2222 Bullish Randy Jackson Pattern Detected")
alertcondition(ftfc[lookback],             title="FTFC", message="All timeframes aligned!")
alertcondition(is_mon_green[lookback],     title="Monthly Green", message="Monthly is Green")
alertcondition(is_wk_green[lookback],      title="Weekly Green",  message="Weekly is Green")
alertcondition(is_d_green[lookback],       title="Daily Green",   message="Daily is Green")
//alertcondition(is_30m_green[lookback],     title="30m Green",     message="30m is Green")

// === Plots (Original) ===
plot(close[lookback], color=color.white, title="Price")
plot(rank[lookback], color=color.blue, linewidth=2, title="Rank")
plot(adr_percent[lookback],   title="ADR %",             color=color.blue, style=plot.style_histogram, linewidth=2)
plot(rel_vol[lookback],      title="Rvol [TOD]", linewidth=2)
plot(lodDist[lookback],       title="LOD ",   color=color.blue, style=plot.style_histogram, linewidth=2)
plot(dcr[lookback],           title="Close Range",        color=color.blue, style=plot.style_histogram, linewidth=2)
plot(chgFromOpen[lookback],   title="Change from open",   color=color.blue, style=plot.style_histogram, linewidth=2)
plot(gapPct[lookback],        title="Gap %",             color=color.blue, style=plot.style_histogram, linewidth=2)
plot(gapPct/adr_percent[lookback], title="Gap/ADR",        color=color.blue, style=plot.style_histogram, linewidth=2)
plot(change12M[lookback],       title="Yearly Change",    color=color.blue, style=plot.style_histogram, linewidth=2)
plot(change3M[lookback],       title="Quarterly Change",    color=color.blue, style=plot.style_histogram, linewidth=2)
plot(changeM[lookback],       title="Monthly Change",    color=color.blue, style=plot.style_histogram, linewidth=2)
plot(changeW[lookback],       title="Weekly Change",     color=color.blue, style=plot.style_histogram, linewidth=2)
plot(changeD[lookback],       title="Daily Change",      color=color.blue, style=plot.style_histogram, linewidth=2)
//plot(change30[lookback],      title="30m Change",        color=color.blue, style=plot.style_histogram, linewidth=2)
plot(stratBar[lookback],      title="Strat Bar",         color=color.blue, style=plot.style_histogram, linewidth=2)

//Create info table
var table info_table = table.new(position.top_right, 2, 11, bgcolor=color.white, border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "Metric", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)

//    table.cell(info_table, 0, 1, "Bearish[1]", text_color=color.black)
//    table.cell(info_table, 1, 1, isBearish[1] ? "Yes" : "N0")

//    table.cell(info_table, 0, 2, "> 50% DCR[1] ", text_color=color.black)
//    table.cell(info_table, 1, 2,  dOpen > (((dLow[1]+ dHigh[1])/2)) ? "Yes" : "N0")
               
    table.cell(info_table, 0, 3, "adr_percent", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(adr_percent, "#.##"), text_color=color.black)

//    table.cell(info_table, 0, 4, "dLow[1]", text_color=color.black)
//    table.cell(info_table, 1, 4, str.tostring(dLow[1], "#.##"), text_color=color.black)

//    table.cell(info_table, 0, 5, "50% DCR[1]", text_color=color.black)
//    table.cell(info_table, 1, 5, str.tostring((dLow[1]+ dHigh[1])/2, "#.##"), text_color=color.black)

    table.cell(info_table, 0, 6, "adr_percent_rank", text_color=color.black)
    table.cell(info_table, 1, 6, str.tostring(adr_percent, "#.##"), text_color=color.black) 
